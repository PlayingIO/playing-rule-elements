<!--
`playing-view-conditions`
@group Playing UI
@element playing-view-conditions
-->
<dom-module id="playing-view-conditions">
  <template>
    <style include="mostly-styles">
      *[role=widget] {
        padding-left: 1em;
        border-left: 1px solid #ddd;
      }

      label {
        @apply --mostly-label;
      }

      .fade-6 {
        opacity: 0.6;
      }

      iron-icon.heading {
        margin-left: -5px;
        --iron-icon-width: 16px;
        --iron-icon-height: 16px;
      }

      .content {
        padding: 5px 0px;
        line-height: 1.2rem;
      }

      .metric-point {
        color: #2060df;
      }

      .metric-set {
        color: #551fad;
      }

      .metric-state {
        color: #9c1c49;
      }

      .metric-compound {
        color: #000;
      }

      .rule-object {
        padding: 1px 0.25em;
        border: 1px solid currentcolor;
      }

      .rule-object.rule-metric {
        color: #b2aaba;
      }

      .rule-object.rule-team {
        color: #779a2d;
      }

      .rule-object.rule-item {
        color: #fff;
        background-color: #6db2ea;
      }

      .rule-object.rule-timeslice {
        background-color: #222;
        color: #fff;
      }

      .rule-object.rule-role {
        color: #c4662b;
      }

      .rule-object.rule-value {
        background-color: #89b628;
      }

      .rule-operator {
        font-style: italic;
        font-weight: bold;
      }
    </style>

    <mostly-resource id="metrics" path="metrics" schemas="*" response-data={{metrics}} auto cached></mostly-resource>
    <mostly-resource id="actions" path="actions" schemas="*" response-data={{actions}} auto cached></mostly-resource>
    <mostly-resource id="teams" path="teams"" schemas="*" response-data={{teams}} auto cached></mostly-resource>

    <div role="widget">

      <template is="dom-if" if="[[!data.length]]">
        <label>[[i18n('play.rule.command.rule.create.guide')]]</label>
      </template>

      <template is="dom-repeat" items="[[data]]" as="cond">
        <div class="content">
          <!-- and rule -->
          <template is="dom-if" if="[[isEqual(cond.rule, 'and')]]">
            <iron-icon class="heading" icon="[[_ruleIcon(cond.rule)]]"></iron-icon>
            [[i18n('play.rule.condition.desc.and')]]
          </template>

          <!-- or rule -->
          <template is="dom-if" if="[[isEqual(cond.rule, 'or')]]">
            <iron-icon class="heading" icon="[[_ruleIcon(cond.rule)]]"></iron-icon>
            [[i18n('play.rule.condition.desc.or')]]
          </template>

          <!-- metric rule -->
          <template is="dom-if" if="[[isEqual(cond.rule, 'metric')]]">
            <iron-icon class="heading" icon="[[_ruleIcon(cond.rule)]]"></iron-icon>
            [[_ruleDesc(cond.rule, cond.not)]]

            <!-- point metric operator -->
            <template is="dom-if" if="[[isEqual(cond.type, 'point')]]">
              [[findById(metrics, cond.metric, 'name')]]
              [[i18n('play.rule.condition.desc.metric.value')]]
              [[p18n('play.rule.condition.operator', cond.operator)]]
              [[cond.value]].
            </template>

            <!-- set metric operator -->
            <template is="dom-if" if="[[isEqual(cond.type, 'set')]]">
              [[findById(metrics, cond.metric, 'name')]]
              [[i18n('play.rule.condition.desc.metric.item')]]
              [[cond.item]]
              [[p18n('play.rule.condition.operator', cond.operator)]]
              [[cond.value]].
            </template>

            <!-- state metric operator -->
            <template is="dom-if" if="[[isEqual(cond.type, 'state')]]">
              [[findById(metrics, cond.metric, 'name')]]
              [[i18n('play.rule.condition.desc.metric.state')]]
              [[p18n('play.rule.condition.operator', cond.operator)]]
              [[cond.value]].
            </template>

            <!-- compound metric operator -->
            <template is="dom-if" if="[[isEqual(cond.type, 'compound')]]">
              [[findById(metrics, cond.metric, 'name')]]
              [[i18n('play.rule.condition.desc.metric.value')]]
              [[p18n('play.rule.condition.operator', cond.operator)]]
              [[cond.value]].
            </template>

          </template>

          <!-- action rule -->
          <template is="dom-if" if="[[isEqual(cond.rule, 'action')]]">
            <iron-icon class="heading" icon="[[_ruleIcon(cond.rule)]]"></iron-icon>
            [[_ruleDesc(cond.rule)]]
            [[findById(actions, cond.action, 'name')]]
            [[p18n('play.rule.condition.operator', cond.operator)]]
            [[cond.value]]
            [[i18n('play.rule.condition.desc.action.value')]].
          </template>

          <!-- team rule -->
          <template is="dom-if" if="[[isEqual(cond.rule, 'team')]]">
            <iron-icon class="heading" icon="[[_ruleIcon(cond.rule)]]"></iron-icon>
            [[_ruleDesc(cond.rule)]]
            [[findById(teams, cond.team, 'name')]]
            [[i18n('play.rule.team.role.with')]]
            [[cond.role]].
          </template>
        </div>

        <template is="dom-if" if="[[cond.conditions]]">
          <playing-view-conditions id="[[index]]" data="[[cond.conditions]]"></playing-view-conditions>
        </template>

      </template>
    </div>

  </template>

  <script>
    class PlayingViewConditions extends Polymer.mixinBehaviors(
        [Mostly.I18nBehavior, Mostly.FuncBehavior, Playing.RuleBehavior], Polymer.Element) {

      static get is() { return 'playing-view-conditions' };
      
      static get properties() {
        return {
          /**
           * the rules array
           */
          data: {
            type: Array,
            value: [],
            notify: true
          },

          /**
           * metrics
           */
          metrics: {
            type: Array
          },

          /**
           * actions
           */
          actions: {
            type: Array
          },

          /**
           * teams
           */
          teams: {
            type: Array
          },

          /**
           * all rule types
           */
          conditionRules: {
            type: Array,
            value: ['metric', 'action', 'team', 'and', 'or']
          },

          /**
           * all operation types
           */
          operationTypes: {
            type: Array,
            value: ['eq', 'ne', 'gt', 'ge', 'lt', 'le']
          },

          /**
           * equal or not operations
           */
          operationEquals: {
            type: Array,
            value: ['eq', 'ne']
          }
        };
      }

      _ruleIcon(type) {
        switch (type) {
          case 'metric': return 'playing:metric';
          case 'action': return 'playing:action';
          case 'team': return 'playing:team';
          case 'and': return 'playing:all-done';
          case 'or': return 'playing:done';
        }
      }

      _ruleDesc(type, not) {
        switch (type) {
          case 'metric': return this.i18n('play.rule.condition.desc.metric.' + !not);
          case 'action': return this.i18n('play.rule.condition.desc.action');
          case 'team': return this.i18n('play.rule.condition.desc.team.' + !not);
          case 'and': return this.i18n('play.rule.condition.desc.and');
          case 'or': return this.i18n('play.rule.condition.desc.or');
        }
      }

      _hasConditions(rule) {
        return rule && (rule === 'and' || rule === 'or');
      }
    }

    customElements.define(PlayingViewConditions.is, PlayingViewConditions);
  </script>
</dom-module>
